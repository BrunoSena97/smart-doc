<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartDoc Clinical Simulation</title>
    <link rel="stylesheet" type="text/css" href="/static/style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>
<body>
        <div class="chat-container">
        <header>
            <h1>SmartDoc - Medical Education Assistant</h1>
            <div>Ask questions naturally - information will be discovered as you explore the case</div>
        </header>

        <!-- Discovery Stats Panel -->
        <div id="discovery-stats" style="display: none;">
            <div class="stats-title" style="font-weight: bold; margin-bottom: 5px;">Discovery Progress</div>
            <div class="stats-item">Discovered: 0/0</div>
            <div class="stats-item">Progress: 0%</div>
            <div class="stats-item">Events: 0</div>
        </div>

        <main id="chatbox" class="chat-log">
            <!-- Initial bot message from Flask will be here -->
            <div class="message bot-message">
                <div class="avatar bot-avatar">
                    <!-- SVG for a medical cross icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="white"><path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"/></svg>
                </div>
                <div class="message-bubble">
                    <span>{{ initial_bot_message }}</span>
                </div>
            </div>
        </main>

        <div class="chat-input-area">
            <form id="chat-form" class="chat-input-form">
                <textarea id="chat-input" placeholder="Ask a question..." rows="1"></textarea>
                <button type="submit" id="send-button">
                    <!-- SVG for a send icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"><path d="M120-160v-240l320-80-320-80v-240l760 320-760 320Z"/></svg>
                </button>
            </form>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            const chatLog = $('#chatbox');
            const chatInput = $('#chat-input');
            const chatForm = $('#chat-form');

            // Function to scroll chat to the bottom
            function scrollToBottom() {
                chatLog.scrollTop(chatLog[0].scrollHeight);
            }

            // Function to append a new message and scroll
            function appendMessage(html) {
                chatLog.append(html);
                scrollToBottom();
            }

            // Function to show bias warnings
            function showBiasWarning(biasType, message) {
                const warningHtml = `
                    <div class="message bias-warning" data-bias-type="${biasType}">
                        <div class="avatar warning-avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="#ff9800">
                                <path d="M480-280q17 0 28.5-11.5T520-320q0-17-11.5-28.5T480-360q-17 0-28.5 11.5T440-320q0 17 11.5 28.5T480-280Zm-40-160h80v-240h-80v240Zm40 360q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/>
                            </svg>
                        </div>
                        <div class="message-bubble warning-bubble">
                            <div class="warning-header">‚ö†Ô∏è Cognitive Bias Alert</div>
                            <span>${message}</span>
                            <div class="warning-dismiss" onclick="dismissWarning(this)">Dismiss</div>
                        </div>
                    </div>`;
                appendMessage(warningHtml);
            }

            // Function to dismiss bias warnings
            window.dismissWarning = function(element) {
                $(element).closest('.bias-warning').fadeOut(300);
            };

            // Function to show discovery notifications
            function showDiscoveryNotifications(discoveries) {
                discoveries.forEach(function(discovery) {
                    const criticalBadge = discovery.is_critical ? '<span class="critical-badge">CRITICAL</span>' : '';
                    const discoveryHtml = `
                        <div class="message discovery-notification" data-block-type="${discovery.block_type}">
                            <div class="avatar discovery-avatar">
                                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="#4caf50">
                                    <path d="M382-240 154-468l57-57 171 171 367-367 57 57-424 424Z"/>
                                </svg>
                            </div>
                            <div class="message-bubble discovery-bubble">
                                <div class="discovery-header">
                                    üìã New Information Discovered ${criticalBadge}
                                </div>
                                <div class="discovery-type">${discovery.block_type}</div>
                                <div class="discovery-content">${discovery.content}</div>
                                <div class="discovery-dismiss" onclick="dismissDiscovery(this)">Dismiss</div>
                            </div>
                        </div>`;
                    appendMessage(discoveryHtml);
                });
            }

            // Function to show general notifications
            function showGeneralNotifications(notifications) {
                notifications.forEach(function(notification) {
                    const notificationHtml = `
                        <div class="message general-notification" data-type="${notification.type}">
                            <div class="avatar notification-avatar">
                                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="#2196f3">
                                    <path d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm-40-360h80v-240h-80v240Zm40 120q17 0 28.5-11.5T520-360q0-17-11.5-28.5T480-400q-17 0-28.5 11.5T440-360q0 17 11.5 28.5T480-320Z"/>
                                </svg>
                            </div>
                            <div class="message-bubble notification-bubble">
                                <span>${notification.message}</span>
                            </div>
                        </div>`;
                    appendMessage(notificationHtml);
                });
            }

            // Function to update discovery stats
            function updateDiscoveryStats(stats) {
                // Show and update the stats panel
                const statsPanel = $('#discovery-stats');
                statsPanel.show();
                statsPanel.html(`
                    <div class="stats-title" style="font-weight: bold; margin-bottom: 5px;">Discovery Progress</div>
                    <div class="stats-item">Discovered: ${stats.revealed_blocks}/${stats.total_blocks}</div>
                    <div class="stats-item">Progress: ${stats.discovery_percentage.toFixed(1)}%</div>
                    <div class="stats-item">Events: ${stats.total_discovery_events}</div>
                    <div class="stats-item">Duration: ${stats.session_duration_minutes.toFixed(1)}m</div>
                `);
            }

            // Function to dismiss discovery notifications
            window.dismissDiscovery = function(element) {
                $(element).closest('.discovery-notification').fadeOut(300);
            };

            // Function to handle sending a message
            function sendMessage() {
                const userInput = chatInput.val().trim();
                if (userInput === "") {
                    return;
                }

                // Display user's message
                const userHtml = `
                    <div class="message user-message">
                        <div class="avatar user-avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="white"><path d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-160v-112q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v112H160Z"/></svg>
                        </div>
                        <div class="message-bubble">
                            <span>${userInput}</span>
                        </div>
                    </div>`;
                appendMessage(userHtml);
                chatInput.val("");
                chatInput.css('height', 'auto'); // Reset height after sending

                // Get bot response via AJAX
                $.get("/get", { msg: userInput }).done(function(data) {
                    // Show discovery notifications first if any
                    if (data.has_discoveries && data.discoveries && data.discoveries.length > 0) {
                        showDiscoveryNotifications(data.discoveries);
                    }

                    // Display bot response
                    const botHtml = `
                        <div class="message bot-message">
                            <div class="avatar bot-avatar">
                                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="white"><path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"/></svg>
                            </div>
                            <div class="message-bubble">
                                <span>${data.response}</span>
                                ${data.has_discoveries ? '<div class="discovery-badge">üìã Information Discovered</div>' : ''}
                            </div>
                        </div>`;
                    appendMessage(botHtml);

                    // Check for bias warning
                    if (data.bias_warning && data.bias_warning.show) {
                        showBiasWarning(data.bias_warning.type, data.bias_warning.message);
                    }

                    // Show additional notifications if any
                    if (data.notifications && data.notifications.length > 0) {
                        showGeneralNotifications(data.notifications);
                    }

                    // Update discovery stats if available
                    if (data.discovery_stats) {
                        updateDiscoveryStats(data.discovery_stats);
                    }
                });
            }

            // Event handler for form submission (handles both button click and Enter)
            chatForm.on('submit', function(e) {
                e.preventDefault(); // Prevent page reload
                sendMessage();
            });

            // Auto-grow textarea as user types
            chatInput.on('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // Scroll to bottom on initial load
            scrollToBottom();
        });
    </script>
</body>
</html>
